import { NextRequest, NextResponse } from 'next/server'
import { db } from '@/lib/db'

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const poId = searchParams.get('poId')
    const programId = searchParams.get('programId')

    if (!poId && !programId) {
      return NextResponse.json(
        { error: 'PO ID or Program ID is required' },
        { status: 400 }
      )
    }

    // Get PO with its CO-PO mappings
    const po = await db.programOutcome.findFirst({
      where: {
        poId: poId || undefined,
        programId: programId || undefined
      },
      include: {
        program: {
          select: {
            name: true,
            code: true
          }
        },
        coPoMappings: {
          include: {
            co: {
              include: {
                course: {
                  include: {
                    enrollments: {
                      include: {
                        student: {
                          include: {
                            marks: {
                                include: {
                                  assessmentQuestion: {
                                    include: {
                                      assessment: {
                                        select: {
                                          type: true
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    })

    if (!po) {
      return NextResponse.json(
        { error: 'Program Outcome not found' },
        { status: 404 }
      )
    }

    // Get indirect attainment from database
    const indirectAttainment = po.indirectAttainment || 3.0

    // Calculate direct PO attainment
    const directAttainment = await calculateDirectAttainment(po)

    // Get system settings for weights
    const directWeight = 70
    const indirectWeight = 30

    // Calculate overall PO attainment
    const overallAttainment = (directAttainment * (directWeight / 100)) + (indirectAttainment * (indirectWeight / 100))

    return NextResponse.json({
      po: {
        id: po.id,
        code: po.code,
        description: po.description,
        program: po.program,
        indirectAttainment
      },
      calculations: {
        directAttainment: parseFloat(directAttainment.toFixed(2)),
        indirectAttainment: parseFloat(indirectAttainment.toFixed(2)),
        directWeight,
        indirectWeight,
        overallAttainment: parseFloat(overallAttainment.toFixed(2))
      },
      details: {
        coPoMappings: po.coPoMappings
      }
    })

  } catch (error) {
    console.error('Failed to calculate PO attainment:', error)
    return NextResponse.json(
      { error: 'Failed to calculate PO attainment' },
      { status: 500 }
    )
  }
}

export async function PUT(request: NextRequest) {
  try {
    const body = await request.json()
    const { poId, indirectAttainment } = body

    if (!poId || indirectAttainment === undefined) {
      return NextResponse.json(
        { error: 'PO ID and indirect attainment are required' },
        { status: 400 }
      )
    }

    // Validate indirect attainment
    if (indirectAttainment < 0 || indirectAttainment > 3) {
      return NextResponse.json(
        { error: 'Indirect attainment must be between 0 and 3' },
        { status: 400 }
      )
    }

    // Update PO with new indirect attainment
    const updatedPo = await db.programOutcome.update({
      where: { id: poId },
      data: {
        indirectAttainment
      }
    })

    return NextResponse.json({
      message: 'Indirect attainment updated successfully',
      po: updatedPo
    })

  } catch (error) {
    console.error('Failed to update indirect attainment:', error)
    return NextResponse.json(
      { error: 'Failed to update indirect attainment' },
      { status: 500 }
    )
  }
}

async function calculateDirectAttainment(po: any): Promise<number> {
  if (!po.coPoMappings || po.coPoMappings.length === 0) {
    return 0
  }

  let weightedSum = 0
  let totalWeight = 0

  for (const mapping of po.coPoMappings) {
    const coAttainmentLevel = await getCOAttainmentLevel(mapping.co.id)
    
    if (coAttainmentLevel !== null) {
      weightedSum += coAttainmentLevel * mapping.level
      totalWeight += mapping.level
    }
  }

  return totalWeight > 0 ? weightedSum / totalWeight : 0
}

async function getCOAttainmentLevel(coId: string): Promise<number | null> {
  try {
    const coQuestions = await db.assessmentQuestion.findMany({
      where: { coId },
      include: {
        assessment: {
          include: {
            course: {
              select: {
                target: true,
                attainmentLevel1: true,
                attainmentLevel2: true,
                attainmentLevel3: true
              }
            }
          }
        },
        marks: {
          include: {
            student: {
              select: {
                id: true
              }
            }
          }
        }
      }
    })

    if (coQuestions.length === 0) {
      return null
    }

    const course = coQuestions[0]?.assessment.course

    if (!course) {
      return null
    }

    const enrollments = await db.enrollment.findMany({
      where: { courseId: course.id },
      include: {
        student: {
          select: {
            id: true
          }
        }
      }
    })

    let studentsMeetingTarget = 0
    const totalStudents = enrollments.length

    for (const enrollment of enrollments) {
      let totalObtained = 0
      let totalMax = 0

      for (const question of coQuestions) {
        const studentMark = question.marks.find(mark => mark.studentId === enrollment.studentId)
        if (studentMark) {
          totalObtained += studentMark.marks
          totalMax += question.maxMarks
        }
      }

      const attainmentPercentage = totalMax > 0 ? (totalObtained / totalMax) * 100 : 0
      if (attainmentPercentage >= course.target) {
        studentsMeetingTarget++
      }
    }

    const percentageMeetingTarget = totalStudents > 0 ? (studentsMeetingTarget / totalStudents) * 100 : 0

    let attainmentLevel = 0
    if (percentageMeetingTarget >= course.attainmentLevel3) attainmentLevel = 3
    else if (percentageMeetingTarget >= course.attainmentLevel2) attainmentLevel = 2
    else if (percentageMeetingTarget >= course.attainmentLevel1) attainmentLevel = 1

    return attainmentLevel
  } catch (error) {
    console.error('Error calculating CO attainment level:', error)
    return null
  }
}