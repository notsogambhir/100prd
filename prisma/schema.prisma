// NBA OBE Portal Database Schema
// Based on PRD specifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Core User Management
model User {
  id          String   @id @default(cuid())
  username    String   @unique
  email       String   @unique
  password    String
  name        String
  role        UserRole
  collegeId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  college       College?           @relation(fields: [collegeId], references: [id])
  programCoordinations Program[]    @relation("ProgramCoordinator")
  teacherAssignments   TeacherAssignment[] @relation("Teacher")
  courseAssignments    CourseAssignment[]
  pcAssignments        TeacherAssignment[] @relation("PC")

  @@map("users")
}

enum UserRole {
  ADMIN
  UNIVERSITY
  DEPARTMENT
  PC
  TEACHER
}

// Academic Structure
model College {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  users     User[]
  programs  Program[]

  @@map("colleges")
}

model Program {
  id          String   @id @default(cuid())
  name        String
  code        String
  duration    Int      // in years
  collegeId   String
  target      Float    @default(60.0) // target percentage for attainment
  level1      Float    @default(40.0) // attainment thresholds
  level2      Float    @default(60.0)
  level3      Float    @default(80.0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  college        College             @relation(fields: [collegeId], references: [id])
  batches        Batch[]
  courses        Course[]
  programOutcomes ProgramOutcome[]
  coordinatorId  String?
  coordinator    User?               @relation("ProgramCoordinator", fields: [coordinatorId], references: [id])

  @@unique([collegeId, code])
  @@map("programs")
}

model Batch {
  id          String   @id @default(cuid())
  name        String
  startYear   Int
  endYear     Int
  programId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  program  Program   @relation(fields: [programId], references: [id])
  sections Section[]
  courses  Course[]

  @@unique([programId, name])
  @@map("batches")
}

model Section {
  id        String   @id @default(cuid())
  name      String
  batchId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  batch           Batch                @relation(fields: [batchId], references: [id])
  students        Student[]
  courses         Course[]
  courseAssignments CourseAssignment[]
  assessments     Assessment[]

  @@unique([batchId, name])
  @@map("sections")
}

// Course Management
model Course {
  id          String      @id @default(cuid())
  code        String
  name        String
  credits     Int
  programId   String
  batchId     String
  status      CourseStatus @default(FUTURE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relationships
  program           Program            @relation(fields: [programId], references: [id])
  batch             Batch              @relation(fields: [batchId], references: [id])
  sections          Section[]
  courseOutcomes    CourseOutcome[]
  assessments       Assessment[]
  courseAssignments CourseAssignment[]
  coPoMappings      CoPoMapping[]
  enrollments       Enrollment[]

  @@unique([programId, code])
  @@map("courses")
}

enum CourseStatus {
  FUTURE
  ACTIVE
  COMPLETED
}

model CourseAssignment {
  id        String   @id @default(cuid())
  courseId String
  teacherId String
  sectionId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  course   Course   @relation(fields: [courseId], references: [id])
  teacher  User     @relation(fields: [teacherId], references: [id])
  section  Section? @relation(fields: [sectionId], references: [id])

  @@unique([courseId, teacherId, sectionId])
  @@map("course_assignments")
}

// Student Management
model Student {
  id          String   @id @default(cuid())
  registerNo  String   @unique
  name        String
  email       String?
  status      StudentStatus @default(ACTIVE)
  sectionId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  section     Section?      @relation(fields: [sectionId], references: [id])
  enrollments Enrollment[]
  marks       Mark[]

  @@map("students")
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
}

model Enrollment {
  id        String   @id @default(cuid())
  studentId String
  courseId String
  createdAt DateTime @default(now())

  // Relationships
  student Student @relation(fields: [studentId], references: [id])
  course  Course  @relation(fields: [courseId], references: [id])

  @@unique([studentId, courseId])
  @@map("enrollments")
}

// Outcomes Management
model CourseOutcome {
  id          String   @id @default(cuid())
  code        String
  description String
  courseId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  course         Course            @relation(fields: [courseId], references: [id])
  coPoMappings   CoPoMapping[]
  assessmentQuestions AssessmentQuestion[]

  @@unique([courseId, code])
  @@map("course_outcomes")
}

model ProgramOutcome {
  id          String   @id @default(cuid())
  code        String
  description String
  programId   String
  indirectAttainment Float? @default(3.0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  program      Program      @relation(fields: [programId], references: [id])
  coPoMappings CoPoMapping[]

  @@unique([programId, code])
  @@map("program_outcomes")
}

model CoPoMapping {
  id           String @id @default(cuid())
  courseId     String
  coId         String
  poId         String
  level        Int    // 1, 2, or 3 for correlation strength

  // Relationships
  course Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  co     CourseOutcome @relation(fields: [coId], references: [id], onDelete: Cascade)
  po     ProgramOutcome @relation(fields: [poId], references: [id], onDelete: Cascade)

  @@unique([courseId, coId, poId])
  @@map("co_po_mappings")
}

// Assessment Management
model Assessment {
  id          String         @id @default(cuid())
  name        String
  type        AssessmentType
  courseId    String
  sectionId   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relationships
  course   Course              @relation(fields: [courseId], references: [id])
  section  Section             @relation(fields: [sectionId], references: [id])
  questions AssessmentQuestion[]

  @@map("assessments")
}

enum AssessmentType {
  INTERNAL
  EXTERNAL
}

model AssessmentQuestion {
  id           String   @id @default(cuid())
  assessmentId String
  questionName String
  maxMarks     Float
  coId         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  assessment Assessment      @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  co         CourseOutcome?  @relation(fields: [coId], references: [id])
  marks      Mark[]

  @@map("assessment_questions")
}

// Grading and Marks
model Mark {
  id               String   @id @default(cuid())
  studentId        String
  assessmentQuestionId String
  marks            Float
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relationships
  student           Student            @relation(fields: [studentId], references: [id])
  assessmentQuestion AssessmentQuestion @relation(fields: [assessmentQuestionId], references: [id])

  @@unique([studentId, assessmentQuestionId])
  @@map("marks")
}

// Faculty Management
model TeacherAssignment {
  id         String   @id @default(cuid())
  teacherId  String
  pcId       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relationships
  teacher User  @relation("Teacher", fields: [teacherId], references: [id])
  pc      User  @relation("PC", fields: [pcId], references: [id])

  @@unique([teacherId, pcId])
  @@map("teacher_assignments")
}